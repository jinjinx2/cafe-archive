/**
 * 게시판 슬라이드 모듈 (게시물 목록, 하단 페이징에 슬라이드 적용)
 * @singleton
 * @required - listId(목록 스와이프), pageId(하단 페이징 슬라이드 - prevBtnId, nextBtnId도 필수값)
 * 
 */
var BoardSlideManager = {
	pageSlide: null,
	pageDelegator: null,
	config: {
		listId: null,
		prevBtnId: null,
		nextBtnId: null
	},
	init: function(config, pageConfig) {
		if (config) {
			jQuery.extend(this.config, config);
		}
		
		if (pageConfig) {
			this.pageDelegator = new PageController(pageConfig);
		}
		
		this.createSlide();
	},
	createSlide: function() {
		if(!this.config.listId){
			return;
		}

		var self = this;
		var prevPage = self.pageDelegator.currentPage - 1;
		var nextPage = self.pageDelegator.currentPage + 1;

		var swipeConfig = {
			targetId: this.config.listId,
			prevBtnLabel: (this.pageDelegator.hasPrevPage()) ? prevPage +"P" : "",
			nextBtnLabel: (this.pageDelegator.hasNextPage()) ? nextPage +"P" : "",
			enabledPrev: (this.pageDelegator.hasPrevPage()) ? true : false,
			enabledNext: (this.pageDelegator.hasNextPage()) ? true : false,
			callbackPrev: function() {
				if (self.pageDelegator.hasPrevPage()) {
					window.location.href = self.pageDelegator.getURL(prevPage);

					ViewSwipeGestureManager.enabledPrev = true;

					ViewSwipeGestureManager.updateSwipeButtonLabel();
				} else {
					ViewSwipeGestureManager.enabledPrev = false;
				}
			},
			callbackNext: function() {
				if (self.pageDelegator.hasNextPage()) {
					window.location.href = self.pageDelegator.getURL(nextPage);

					ViewSwipeGestureManager.enabledNext = true;
				} else {
					ViewSwipeGestureManager.enabledNext = false;
				}
			}
		};

		ViewSwipeGestureManager.init(swipeConfig);
	}
};

/**
 * 스와이프 제스처 모듈 (게시물 목록, 게시물 읽기뷰)
 * @singleton
 * @required - targetId
 * 
 */
var ViewSwipeGestureManager = {
	listener: null,
	defaultTop: 198,
	startX: 0,
	moveVal: 0,
	isSwipeArea: false,
	direction: null,
	targetId: null,
	prevBtn: null,
	nextBtn: null,
	prevBtnLabel: "",
	nextBtnLabel: "",
	enabledPrev: true,
	enabledNext: true,
	callbackPrev: null,
	callbackNext: null,
	init: function(config) {
		if (config) {
			jQuery.extend(this, config);

			this.listener = gesture.GestureListener(jQuery(this.targetId)[0], 0);
			
			this.makeGuideSwipeButtons();
			
			this.addStartGestureAction();
			this.addMoveGestureAction();
			this.addEndGestureAction();	
		}
	},
	makeGuideSwipeButtons: function() {
		var prevLabel = this.prevBtnLabel;
		var nextLabel = this.nextBtnLabel;
		var guideButtons = '<div id="layerMoveCenter" class="cafe_swipe" style="top:'+ this.defaultTop +'px;">';
		guideButtons += '<button id="btnSwipeLeft" class="btn_swipe btn_prev"><span class="ico_cafe ico_prev">이전</span><span class="txt_swipe">'+ prevLabel +'</span></button>';
		guideButtons += '<button id="btnSwipeRight" class="btn_swipe btn_next"><span class="ico_cafe ico_next">다음</span><span class="txt_swipe">'+ nextLabel +'</span></button></div>';
		
		var wrapEl = jQuery(this.targetId);
		wrapEl.css("position", "relative");
		wrapEl.append(guideButtons);
		
		jQuery(window).on("scroll", function() {
			var layer = jQuery("#layerMoveCenter");
			layer.css("top",window.pageYOffset);
		});
		
		this.prevBtn = jQuery("#btnSwipeLeft");
		this.prevBtn.css("opacity", 0);
		this.prevBtn.css("left", -50);
		
		this.nextBtn = jQuery("#btnSwipeRight");
		this.nextBtn.css("opacity", 0);
		this.nextBtn.css("right", -50);
	},
	addStartGestureAction: function() {
		var self = this;
		
		this.listener.onGestureStart(function(session) {
			self.startX = session.startPos.x;
		});
	},
	addMoveGestureAction: function() {
		var self = this;
		
		this.listener.onGestureMove(function(session) {
			if (session.type == "swipe") {
				event.preventDefault();
				
				self.direction = (session.delta.x > 0) ? "right" : "left";
				self.isSwipeArea = true;
				if (self.direction == "left" && !self.enabledNext) { self.isSwipeArea = false; return; }
				if (self.direction == "right" && !self.enabledPrev) { self.isSwipeArea = false; return; }
				
				var targetBtn = (self.direction == "left") ? self.nextBtn : self.prevBtn;
				var position = (self.direction == "left") ? "right" : "left";
			   	var delta = ((session.delta.x > 0) ? session.delta.x * -1 : session.delta.x) /2;
			   	var styles = {};
			   	
			   	styles[position] = self.moveVal = Math.min((-50 - delta), 0);
			   	styles["opacity"] = Math.min((delta*-2/100),1);
			   	targetBtn.css(styles);
		   	}
		});
	},
	addEndGestureAction: function() {
		var self = this;
		
		this.listener.onGestureEnd(function(session) {
		   	if (session.type == "swipe") {
		   		if (!self.isSwipeArea) return;
		   		
		   		var targetBtn = (self.direction == "left") ? self.nextBtn : self.prevBtn;
		   		var position = (self.direction == "left") ? "right" : "left";
		   		var styles = {};
		   		
		   		for (var i=self.moveVal; i>=-50; i--) {
				   	styles[position] = i;
				   	styles["opacity"] = 1-(i*-2/100);
				   	targetBtn.css(styles);
		   		}

		   		if (!self.moveVal) {
			   		if (session.isLeft()) {
			   			if (typeof self.callbackNext == "function") {
			   				LoadingIndicator.show();
			   				self.callbackNext();
			   			}
			   		} else {
			   			if (typeof self.callbackPrev == "function") {
			   				LoadingIndicator.show();
			   				self.callbackPrev();
			   			}
			   		}
		   		}
		   	}
		});
	},
	updateSwipeButtonLabel: function(labelInfo) {
		if (labelInfo) {
			$("#btnSwipeLeft .txt_desc").html(labelInfo.prevBtnLabel);
			$("#btnSwipeRight .txt_desc").html(labelInfo.nextBtnLabel);
		}
	}
}

/**
 * 페이지 컨트롤러
 * @class
 * @required - page 관련 값들 
 * 
 */
var PageController = function(config) {
	this.boardType = null;
	this.numberOfPagesForGroup = 5;
	this.totalPage = 1;
	this.totalGroup = 1;
	this.currentPage = 1;
	this.dispGroup = 1;
	
	jQuery.extend(this, config);
}

PageController.prototype = {
	isLastPage: function() {
		return (this.currentPage == this.totalPage);
	},
	hasPrevGroup: function(depth) {
		var groupNum = this.dispGroup - depth;
		if (groupNum < 1 || this.totalGroup <= 1) {
			return false;
		}
		return true;
	},
	hasNextGroup: function(depth) {
		var groupNum = this.dispGroup + depth;
		if (groupNum > this.totalGroup) {
			return false;
		}
		return true;
	},
	hasPrevPage: function() {
		var prevNum = this.currentPage - 1;
		return (prevNum);
	},
	hasNextPage: function() {
		var nextNum = this.currentPage + 1;
		return (nextNum <= this.totalPage);
	},
	getPages: function(group) {
		var pages = [];
		
		for (var i = 1; i <= 5 ; i++ ) {
			var page = (group - 1) * this.numberOfPagesForGroup + i;
			
			if (page > this.totalPage) {
				break;
			}
			pages[i-1] = page;
		}
		return pages;
	},
	getCurrentPages: function() {
		return this.getPages(this.dispGroup);
	},
	getNextPages: function(depth) {
		return this.getPages(this.dispGroup+depth);
	},
	getPrevPages: function(depth) {
		return this.getPages(this.dispGroup-depth);			
	},
	moveNextPageGroup: function() {
		if (this.dispGroup < this.totalGroup) {
			this.dispGroup++;
		}
	},
	movePrevPageGroup: function() {
		if (this.dispGroup > 0) {
			this.dispGroup--;	
		}
	},
	moveNextPage: function() {
		if (this.dispGroup < this.totalGroup) {
			this.dispGroup++;
		}
	},
	movePrevPage: function() {
		if (this.dispGroup > 0) {
			this.dispGroup--;	
		}
	},
	getURL: function(requestPage) {
		var url = this.linkUrl;
		if (this.boardType != "C") { url += "?prev_page=" + this.currentPage; }
		if (requestPage) { url += ((this.boardType != "C") ? "&":"?") + "page="+ requestPage; }
		if (this.linkUrlExtraNext) {
			url = (requestPage > this.currentPage) ? url + this.linkUrlExtra : url + this.linkUrlExtraNext;
		} else {
			url += this.linkUrlExtra;
		}
		return url;
	},
	getAjaxURL: function(requestPage) {
		var url = this.linkUrl +".json";
		url += "?prev_page=" + this.currentPage;
		url += "&page="+ requestPage;
		url += this.linkUrlExtra;
		return url;
	}
}

const createNoticeToggleManager = (boardType) => {

	const BOARD_TYPE = { ALL: 'M', MEMO: 'C' };

	const KEY = `NOTI_${CAFEAPP.GRPID}_${CAFEAPP.FLDID}`;
	const VAL = { YES: 'Y', NO: 'N' };

	const NoticeToggleManager = (($) => {

		const container = $('#noticeContainer');
		const notices = container.find('#notices');
		const mustReadNotices = container.find('#mustReadNotices');

		let toggleButton;
		let page;

		function init (currentPage = 1) {
			page = currentPage;
			isOn() ? on() : off();
		}

		function bindEventTo ({ selector, eventName }) {
			toggleButton = $(selector);
			toggleButton.on(eventName, toggle);
		}

		function toggle () {
			container.toggleClass('readnotice_open', !isOn());
			toggleButton.toggleClass('link_noti', !isOn());
			isOn() ? off() : on();
		}

		function on () {
			$.cookie(KEY, VAL.YES);
	
			notices.show();

			if (!isWholeBoard()) {
				hasMustReadNotice() && mustReadNotices.hide();
				if (page !== 1 || (page === 1 && !hasMustReadNotice())) {
					container.show();
				}
			}
		}

		function off () {
			$.cookie(KEY, VAL.NO);
	
			notices.hide();
	
			if (!isWholeBoard()) {
				hasMustReadNotice() && mustReadNotices.show();
				if (page !== 1 || (page === 1 && !hasMustReadNotice())) {
					container.hide();
				}
			}
		}

		function isOn () {
			return boardType === BOARD_TYPE.ALL 
				? $.cookie(KEY) === VAL.YES 
				: $.cookie(KEY) !== VAL.NO;
		}

		function hasMustReadNotice () {
			return mustReadNotices.find('li').length > 0;
		}

		function isWholeBoard () {
			return container.hasClass('boardall_readnotice');
		}

		return { init, bindEventTo };

	})(jQuery);

	const MemoNoticeToggleManager = (($) => {
		
		const container = $('#memoArticles');
		const notices = container.find('li.notice');
		const mustReadNotice = container.find('li.must_read');
		
		let toggleButton;
		let page;

		function init (currentPage = 1) {
			page = currentPage;
			isOn() ? on() : off();
		}

		function bindEventTo ({ selector, eventName }) {
			toggleButton = $(selector);
			toggleButton.on(eventName, toggle);
		}

		function toggle () {
			toggleButton.toggleClass('link_noti', !isOn());
			isOn() ? off() : on();
		}

		function on () {
			$.cookie(KEY, VAL.YES);
			notices.each((i, notice) => container.find(notice).show());
		}

		function off () {
			$.cookie(KEY, VAL.NO);
			notices.each((i, notice) => container.find(notice).hide());
			(page === 1 && mustReadNotice.length) && mustReadNotice.show();
		}

		function isOn () {
			return $.cookie(KEY) !== VAL.NO;
		}

		return { init, bindEventTo };

	})(jQuery);
	
	return boardType !== BOARD_TYPE.MEMO 
		? NoticeToggleManager 
		: MemoNoticeToggleManager;
};

/**
 * 게시판 관리 모듈
 * @singleton 
 * 
 */
var boardManage = {
	type : null,
	boardType : null,
	url : location.href,
	init : function(type) {
		this.type = type;
		this.boardType = type;
		if (jQuery('#moveArticleTargets').length > 0) {
			boardManage.loadMoveFolder();	
		}
		if (jQuery('#cafe_select_headcont').length > 0) {
			boardManage.loadHeadCont();
		}
		boardManage.setSelectboxAttribute();
		this.setEvents();
	},
	setEvents: function(){
		this.overridePagingEventsForAdminmode();
		this.setBoardRefreshEvent();
	},
	setBoardRefreshEvent: function(){
		jQuery('#board_refesh').on("click", function(event) {
			event.preventDefault();
			LoadingIndicator.show();
			window.location.href = "/" + CAFEAPP.GRPCODE + "/" + CAFEAPP.FLDID + "?boardType=" + CAFEAPP.BOARDTYPE;
		});
	},
	overridePagingEventsForAdminmode: function(){
		jQuery('#pagingNav').on("click", ".link_page", function(event) {
			event.preventDefault();
			if(boardManage.url.indexOf("adminmode=Y") > -1){
				window.location.href = event.target.href + "&adminmode=Y";
			} else {
				window.location.href = event.target.href.replace("adminmode=Y", "");
			}
		});
	},
	hasCheckedItem : function() {
		return jQuery("[name='checkAdmin']:checked").length > 0;
	},
	setSelectboxAttribute : function() {
		if (boardManage.hasCheckedItem()) {
			jQuery(".tab_btns .opt_select").show();
		} else {
			jQuery(".tab_btns .opt_select").hide();
		}
	},
	on : function(isComment) {
		if (Utils.isGingerbread()) {
			jQuery("#daumWrap").addClass("wrap_control");
		}
		jQuery('#cafe_navi_default').hide();
		jQuery('#cafe_navi_admin').show();
		
		jQuery('.list_cafe').addClass('list_edit');
		jQuery('.edit_check').show();
		
		jQuery('.list_cafe').on('click', 'li', function() {
			var checkBox = jQuery(this).find('.edit_check > input')[0];
			checkBox.checked = checkBox.checked ? false : true;
			boardManage.setSelectboxAttribute();
			return false;
		});
		
		if(boardManage.url.indexOf("adminmode=Y") == -1) {
			if(boardManage.url.indexOf("?") > -1){
				boardManage.url += "&adminmode=Y";
			} else {
				boardManage.url += "?adminmode=Y";
			}

			history.replaceState(null, "", boardManage.url);
		}
        
		if('C' == this.type || 'COMMENT' == this.type) {
			jQuery('#writeForm').hide();
			jQuery('ul .append_btns').hide();
		} else if ('M' == this.type) {
			jQuery('#cafe_list_select').hide();
		} else {
			if (jQuery('#cafe_select_headcont').length > 0) {
				jQuery('#cafe_select_headcont').hide();
			}
		}
		
		var notices = jQuery('#noticeContainer');
		notices.length && notices.hide();
	},
	back : function() {
		if (Utils.isGingerbread()) {
			jQuery("#daumWrap").removeClass("wrap_control");
		}
		if(boardManage.url.indexOf("&adminmode=Y") > -1) {
			boardManage.url = boardManage.url.replace(/&adminmode=Y/g, "");
		} else {
			boardManage.url = boardManage.url.replace(/\?adminmode=Y/g, "");
		}
		
		history.replaceState(null, "", boardManage.url);
		
		jQuery('#cafe_navi_admin').hide();
		jQuery('#cafe_navi_default').show();
		
		jQuery('.list_cafe').off('click', 'li');
		jQuery('.edit_check').hide();
		jQuery('.list_cafe').removeClass('list_edit');
		jQuery('.append_btns').show();
		jQuery('li > .edit_check > input').prop("checked", false);
		if('5' == CAFEAPP.BOARDTYPE || '2' == CAFEAPP.BOARDTYPE){
			jQuery('[name=checkAdmin]:checked').prop("checked", false);
		}
		
		boardManage.setSelectboxAttribute();
		
		if('C' == this.type) {
			jQuery('#writeForm').show();
			jQuery('ul .append_btns').show();
		} else if ('M' == this.type) {
			jQuery('#cafe_list_select').show();
		} else {
			if (jQuery('#cafe_select_headcont').length > 0) {
				jQuery('#cafe_select_headcont').show();
			}
		}
		
		var notices = jQuery('#noticeContainer');
		notices.length && notices.show();
	},
	loadMoveFolder : function() {
		var moveBoardListUrl = boardManage.url.split('?', 1) + '/move';
		var fldid = moveBoardListUrl.split('/')[4];
		
		jQuery.get(moveBoardListUrl, function(data) {
			for(var i = 0; i < data.success.length ; ++i) {
				if(data.success[i].fldid != fldid) {
					jQuery("#moveArticleTargets").append(new Option(data.success[i].name, data.success[i].fldid, false, false));
				}
			}
		});
		
		jQuery("#moveArticleTargets").on("change", function() {
			if(Utils.isiPad()) {
				setTimeout(function() {boardManage.moveArticle();}, 100);
			} else {
				boardManage.moveArticle();
			}
		});
		
	},
	loadHeadCont : function() {
		var headcontListUrl = boardManage.url.split('?', 1) + '/headcont';
		var fldid = headcontListUrl.split('/')[4];
		jQuery.get(headcontListUrl, function(data) {
			jQuery("#modifyHeadcont").append(new Option('말머리없음', '', false, false));
			for(var i = 0; i < data.success.length ; ++i) {
				if(data.success[i].fldid != fldid) {
					jQuery("#modifyHeadcont").append(new Option(data.success[i], data.success[i], false, false));
				}
			}
		});
		jQuery("#modifyHeadcont").on("change", function() {
			if(Utils.isiPad()) {
				setTimeout(function() {boardManage.modifyHeadcont();}, 100);
			} else {
				boardManage.modifyHeadcont();
			}
		});
	},
	checkHeadCont : function() {
		var dataids = boardManage.getDataids();
		if (dataids == null || dataids == '') {
			alert("선택된 게시글이 없습니다.\n말머리 변경할 게시글을 선택해 주세요.");
			return false;
		}
		return true;
	},
	modifyHeadcont : function() {
		var headcont = jQuery('#modifyHeadcont').val();
		if(headcont == 'NOT_CHANGE') {
			return;
		}
		if (!boardManage.checkHeadCont()) {
			return;
		}
		
		var dataids = boardManage.getDataids();
		if('5' == CAFEAPP.BOARDTYPE || '2' == CAFEAPP.BOARDTYPE){
			if(jQuery('[name=checkAdmin]:checked').size() > 100 ){
				alert("한번에 100개 이하만 가능합니다.\n현재 선택 개수 : "+jQuery('[name=checkAdmin]:checked').size()+'개');
				jQuery("#moveArticleTargets").val("");
				return;
			}
		}
		
		if (window.confirm('선택된 게시글의 말머리를 변경하시겠습니까?')) {
			LoadingIndicator.show(".mArticle");
			jQuery.ajax({
				url: '/' + CAFEAPP.GRPCODE + '/' + CAFEAPP.FLDID + '/headcont',
			    type: 'POST',
			    data : {dataids: dataids, headcont: headcont},
			    success: function(result) {
			    	LoadingIndicator.hide();
			    	if('SUCCESS' !== result.code) {
			    		alert(result.msg);
			    	}
			    	jQuery("#moveArticleTargets").val("");
			    	location.reload();	
			    },
			    error : function(result){LoadingIndicator.hide();}
			});	
		}
		
	},
	deleteArticle : function() {
		var dataids = '';
		if (CAFEAPP.FLDID == "_rec") {
			dataids = boardManage.getDataids();
		} else {
			dataids = boardManage.getFldidDataids();
		}
		
		if (dataids == null || dataids == '') {
			alert("선택된 게시글이 없습니다.\n삭제할 게시글을 선택해 주세요.");
			return;
		}
		if('5' == CAFEAPP.BOARDTYPE || '2' == CAFEAPP.BOARDTYPE){
			if(jQuery('[name=checkAdmin]:checked').size() > 100 ){
				alert("한번에 100개 이하만 가능합니다.\n현재 선택 개수 : "+jQuery('[name=checkAdmin]:checked').size()+'개');
				jQuery("#moveArticleTargets").val("");
				return;
			}
		}
		if (window.confirm('선택된 게시글을 삭제하시겠습니까?\n삭제된 글은 복구되지 않습니다.')) {
			LoadingIndicator.show(".mArticle");
			jQuery.ajax({
				url: '/' + CAFEAPP.GRPCODE + '/deleteArticle',
			    type: 'POST',
			    data : {dataids: dataids},
			    success: function(result) {
			    	LoadingIndicator.hide();
			    	if('SUCCESS' !== result.code) {
			    		alert(result.msg);
			    	}
			    	if('5' == CAFEAPP.BOARDTYPE || '2' == CAFEAPP.BOARDTYPE){
			    		jQuery('[name=checkAdmin]:checked').parent().parent().parent().remove();
			    		if(jQuery(".article").size()>0){
			    			var container = document.querySelector('#container');
			    			imagesLoaded( container, function() {
			    				new Masonry( container );
			    			});
			    		}else{
			    			location.reload();
			    		}
			    		jQuery("#moveArticleTargets").val("");
			    	}else{
			    		location.reload();
			    	}
			    },
			    error : function(result){LoadingIndicator.hide();}
			});	
		}
	},
	
	getFldidDataids : function() {
		var params = [];
		jQuery('[name=checkAdmin]:checked').each(function() {
			params.push(CAFEAPP.FLDID + ":" + jQuery(this).val());
		});
		
		return (params.join(","));
	},
	
	getDataids : function() {
		var params = [];
		jQuery('[name=checkAdmin]:checked').each(function() {
			params.push(jQuery(this).val());
		});
		
		return (params.join(","));
	},
	checkMoveArticle : function() {		
		var dataids = [];
		jQuery('[name=checkAdmin]:checked').each(function() {
			dataids.push(jQuery(this).val());
		});
		
		if(dataids.length == 0) {
			alert("선택된 게시글이 없습니다.\n이동할 게시글을 선택해 주세요.");
			return false;
		}
		return true;
	},
	moveArticle : function() {
		var moveToFldid = jQuery('#moveArticleTargets').val();
		if('' == moveToFldid) {
			return;
		}
		if (!boardManage.checkMoveArticle()) {
			return;
		}
		
		var dataids = [];
		jQuery('[name=checkAdmin]:checked').each(function() {
			dataids.push(jQuery(this).val());
		});
		
		if('5' == CAFEAPP.BOARDTYPE || '2' == CAFEAPP.BOARDTYPE){
			if(jQuery('[name=checkAdmin]:checked').size() > 100 ){
				alert("한번에 100개 이하만 가능합니다.\n현재 선택 개수 : "+jQuery('[name=checkAdmin]:checked').size()+'개');
				jQuery("#moveArticleTargets").val("");
				return;
			}
		}
		
		var dataidParams = dataids.join(",");
		 
		setTimeout(function () {
		if (window.confirm('정말로 이동하시겠습니까?\n말머리는 동일한 말머리가 있을 경우에만 유지됩니다.')) {
			LoadingIndicator.show(".mArticle");
			jQuery.ajax({
				url: '/' + CAFEAPP.GRPCODE + '/' + CAFEAPP.FLDID +  '/move',
			    type: 'POST',
			    data : {moveto : moveToFldid, dataids : dataidParams, boardType : CAFEAPP.BOARDTYPE},
			    success: function(result) {
			    	LoadingIndicator.hide();
			    	if('SUCCESS' == result.code) {	    		
			    	} else {
			    		alert(result.msg);
			    	}
			    	if('5' == CAFEAPP.BOARDTYPE || '2' == CAFEAPP.BOARDTYPE){
			    		jQuery('[name=checkAdmin]:checked').parent().parent().parent().remove();
			    		if(jQuery(".article").size()>0){
			    			var container = document.querySelector('#container');
			    			imagesLoaded( container, function() {
			    				new Masonry( container );
			    			});
			    		}else{
			    			location.reload();
			    		}
			    		jQuery("#moveArticleTargets").val("");
			    	}else{
			    		location.reload();
			    	}
			    },
			    error : function(result){LoadingIndicator.hide();}
			});	
		}
		}, 500);
	},
	deleteComment : function() {
		var seqs = [];
		jQuery('[name=checkAdmin]:checked').each(function() {
			seqs.push(jQuery(this).val());
		});
		
		if(seqs.length == 0) {
			alert("선택된 댓글이 없습니다.");
			return;
		}
				
		var seqsParams = seqs.join(",");
		
		if (window.confirm('선택된 댓글을 삭제하시겠습니까?\n삭제된 글은 복구되지 않습니다.')) {
			jQuery.ajax({
				url: '/' + CAFEAPP.GRPCODE + '/' + CAFEAPP.FLDID + '/' + CAFEAPP.DATAID + '/delcomment',
			    type: 'POST',
			    data : {seqs: seqsParams},
			    success: function(result) {
			    	if('SUCCESS' == result.code) {
			    	} else {
			    		alert(result.msg);
			    	}
			    	location.reload();		    		
			    }
			});	
		}
	}
};

/**
 * 댓글 리스트 컨트롤러
 * @class
 * @required - mode
 * 
 */

(function ($) {
	var tagRegex = /<\s?[^>]*\/?\s?>/gi;
	var linkRegex = /https?:\/\/(((([a-z가-힣\d](-*[a-z가-힣\d])*)\.)+[a-z가-힣]{2,}|((\d{1,3}\.){3}\d{1,3}))(:\d+)?(\/[-a-z가-힣\d%_.~+]*)*(\?[;&a-z가-힣\d%_.~+=-]*)?(#[-a-z가-힣\d_]*)?)/gi;
	window.makeLink = function (elementList) {
		$(elementList).each(function (index, element) {
			var htmlText = $(element).html();
			var tags = htmlText.match(tagRegex);
			$(tags).each(function (index, matchTag) { // 텍스티콘 예외 처리
				htmlText = htmlText.replace(matchTag, '{' + index + '}');
			});
			htmlText = htmlText.replace(linkRegex, '<a href="https://$1" target="_blank">$&</a>');
			$(tags).each(function (index, matchTag) { // 텍스티콘 복구 처리
				htmlText = htmlText.replace('{' + index + '}', matchTag);
			});
			$(element).html(htmlText);
		});
	};
})(jQuery);

var CommentListViewController = function(config) {
	jQuery.extend(this, config);
	
	this.init();
};
			
CommentListViewController.prototype = {
	init: function() {
		var commentList = jQuery("#commentList");
    	
    	if (commentList.length) {
    		this.addEventForDeleteButton();
			commentImageToggle.addEventForAttachImage(jQuery(".list_cafe .link_img"));
			window.makeLink(commentList.find(".txt_detail"));
		}
		commentList.on('click', '.comment_report_admin_btn', function (e) {
			var currentTarget = e.currentTarget;
			var commentid= jQuery(currentTarget).data('commentid');
			e.preventDefault();
			return jQuery.ajax({
				type: 'POST',
				url: '/report/comment/availability',
				data: JSON.stringify({grpid: CAFEAPP.GRPID, fldid: CAFEAPP.FLDID, dataid: CAFEAPP.DATAID, cmtdataid: commentid}),
				contentType: 'application/json; charset=utf-8',
			}).done(function () {
				location.assign(currentTarget.href);
			}).fail(function (res) {
				if (res.responseJSON && res.responseJSON.message) {
					alert(res.responseJSON.message);
					return;
				}
				alert('해당 게시글을 제보할 수 없습니다.');
			});
		}).on('click', '.open_layer', function (e) {
			e.stopPropagation();
			var reportLayer = jQuery(e.currentTarget).next();
			commentList.find('.report_layer').hide();
			reportLayer.show();
		});
		jQuery(document).click(function () {
			commentList.find('.report_layer').hide();
		});
	},
	addEventForDeleteButton: function() {
		var deleteButtons = jQuery(".append_btns .btn_delete_comment");

		var self = this;
		for (var i=0, len=deleteButtons.length; i<len; i++) {
			jQuery(deleteButtons[i]).on("click", function(ev) {
				ev.preventDefault();
				self.deleteComment(ev.target);
			});
		}
	},
	deleteComment: function(target) {
		var data = jQuery(target).data();
    	var seq = data.seq;
		
		if (window.confirm('해당 댓글을 삭제하시겠습니까?')) {
			var form = jQuery("#deleteCommentForm");
			form.attr("action", form.attr("action") +'/' + seq + '?method=DELETE&mode='+ this.mode +'&'+ this.searchParam);
			form.submit();
		}
	}
};

var commentImageToggle = {
	addEventForAttachImage: function($attachThumbList) {
		var self = this;
		for (var i = 0, len = $attachThumbList.length; i < len; i++) {
			jQuery($attachThumbList[i]).on("click", function (ev) {
				ev.preventDefault();
				self.toggleImageZoom(ev.target);
			});
		}
	},
	toggleImageZoom: function(target) {
		var $toggleBtn = jQuery(target).parents('a');
		
		var $li = $toggleBtn.parents('li');

		var thumbnail = $li.find(".thumb_info");
		var zoomIcon = $li.find(".icon_zoom");
		var zoomImage = $li.find(".thumb_zoom");
		var zoomBox = $li.find('.box_zoom');
		if (!zoomImage[0]) {
			var imageHtml = jQuery("<div class=\"box_zoom\"><img src=\"" + thumbnail[0].src.replace("C120x120", "R640x0") + "\" class=\"thumb_zoom\"></div>");
			var wrapEl = $li.find('.info_cafe');
			wrapEl.append(imageHtml);
		}

		if ($toggleBtn.hasClass("link_zoom")) {
			$toggleBtn.removeClass("link_zoom");
			zoomIcon.html("이미지 축소");
			zoomBox.hide();
		} else {
			$toggleBtn.addClass("link_zoom");
			zoomIcon.html("이미지 확대");
			zoomBox.show();
		}
	}
};

function showBigFont(ev) {
	$("#article").addClass('big_font');
	$(ev.currentTarget).addClass('zoom_off');
	$('#zoomout').removeClass('zoom_off');
}
function showSmallFont(ev) {
	$("#article").removeClass('big_font');
	$(ev.currentTarget).addClass('zoom_off');
	$('#zoomin').removeClass('zoom_off');
}

/* polyfill es6 string function */
(function(){
	if (!String.prototype.includes) {
		String.prototype.includes = function(search, start) {
			'use strict';
			if (typeof start !== 'number') {
				start = 0;
			}

			if (start + search.length > this.length) {
				return false;
			} else {
				return this.indexOf(search, start) !== -1;
			}
		};
	}
})();

var articleViewController = (function(){
	var article = $("#article");

	function init(){
		setViewEvents();
		initPhocusImageViewer();
		refineArticleContents();
		loadPlusMap();
		allowFullScreenOnMovieIframes();
		setWebToAppEvents();
		initSocialShare();
		resizeTables();
		commentImageToggle.addEventForAttachImage($(".list_cmt .link_img"));
		window.makeLink($(".list_cmt").find(".txt_detail"));
	}
	
	var FAIL_FOR_CC = 100;
	var FAIL_FOR_SPYWARE = 100;
	var FILE_FAIL_MESSAGE = {
		CC_FORBIDDEN: '해당 첨부파일은 저작권 위반이 의심되어 다운로드 받으실 수 없습니다.',
		DENIED_SPYWARE: '해당 첨부파일은 바이러스가 의심되어 다운로드 받으실 수 없습니다.',
		NOT_FOUND: '파일이 존재하지 않습니다.'
	};

	function validateFileAndAlertOnFailure(fileProperty) {
		var isValidFile = false;
		if (!fileProperty || fileProperty.c_result === undefined || fileProperty.m_result === undefined) {
			alert(FILE_FAIL_MESSAGE.NOT_FOUND);
		} else if (fileProperty.c_result === FAIL_FOR_CC) {
			alert(FILE_FAIL_MESSAGE.CC_FORBIDDEN); // 음저권 저촉된 경우
		} else if (fileProperty.m_result === FAIL_FOR_SPYWARE) {
			alert(FILE_FAIL_MESSAGE.DENIED_SPYWARE); // 악성코드 검출된 경우
		} else {
			isValidFile = true;
		}
		return isValidFile;
	}

	// 첨부파일 악성코드/음저권 검사
	function checkFileProperty(fileDownloadUrl, validFileCallback) {
		if (/^http:\/\//.test(fileDownloadUrl)) {
			fileDownloadUrl = fileDownloadUrl.replace('http://', 'https://');
		}
		var propertyUrl = fileDownloadUrl.replace('?download', '?property');

		jQuery.ajax({
			url: propertyUrl,
			type: 'GET',
			success: function(res) {
				if (validateFileAndAlertOnFailure(res)) {
					validFileCallback(fileDownloadUrl);
				}
			},
			error: function() {
				validateFileAndAlertOnFailure();
			}
		});
	}

	function setViewEvents() {
		$('#zoomin').on('click', function (ev) {
			showBigFont(ev);
		});
		$('#zoomout').on('click', function (ev) {
			showSmallFont(ev);
		});

		$('#changerolecode').on('change', function () {
			document.getElementById('changeLevelForm').submit();
		});

		$('#attachList_toggle').on('click', function (ev) {
			ev.preventDefault();
			$('#attachList').toggle();
		});
		$('a.link_seller, #sellerInfo .btn_close').on('click', function (ev) {
			ev.preventDefault();
			$('#sellerInfo').toggle();
		});

		$(document).on('click', function () {
			$('#article_more_button.on').removeClass('on');
		});

		$('.article_more').on('click', function(ev) {
			ev.stopPropagation();
		});
		$('#article_more_button').on('click', function (ev) {
			ev.preventDefault();
			$(ev.currentTarget).toggleClass('on');
		});
		
		function downloadFile(downloadUrl) {
			var fileDownloader = document.querySelector('#fileDownloader');
			fileDownloader.href = downloadUrl;
			fileDownloader.click();
		}

		// 본문의 첨부파일 악성코드/음저권 검사
		$('div[data-ke-type="file"] > a')
			.each(function(index, el) {
				el.href = 'javascript:';
				el.target = '_self';
			})
			.on('click', function(ev) {
				var fileDownloadUrl = $(ev.currentTarget).parent().data('fileSrc');
				checkFileProperty(fileDownloadUrl, downloadFile);
			});

		// 첨부파일 목록 악성코드/음저권 검사
		$('a[data-file-src]').on('click', function(ev) {
			var fileDownloadUrl = ev.currentTarget.dataset.fileSrc;
			checkFileProperty(fileDownloadUrl, downloadFile);
		});
	}
	
	function initPhocusImageViewer() {
		if (typeof phocus === 'undefined') {
			return;
		}
		
		var articleTitle = $('#mArticle .article_title').text().trim();
		var images = Array.from(article.find('img').filter(needViewer).map(elementToPhocusImage));

		function needViewer() {
			var imgEl = this;
			var a = $(this).closest('a');
			
			if (!/^https?:\/\//.test(imgEl.src)) {
				return false;
			}

			var isCDNImage = imgEl.src.includes('daumcdn.net/cafe_image') || imgEl.src.includes('daumcdn.net/cafeimg');
			var isTVpotImage = imgEl.src.includes('tvpot_thumb');
			var isMapImage = imgEl.src.includes('map.daumcdn.net');
			var isEmoticon = imgEl.src.includes('/emoticon/');
			var isLinkedImage = a.length !== 0;
			return !(isCDNImage || isTVpotImage || isMapImage || isEmoticon || isLinkedImage);
		}
		
		function elementToPhocusImage() {
			return {
				element: this,
				title: articleTitle,
				src: this.src,
				thumbnail: Utils.getThumbnail(this.src, 200, 200, 'C'),
			};
		}
		
		if (images.length < 1) {
			return;
		}
		
		var phocusContainer = document.createElement('div');
		document.body.appendChild(phocusContainer);

		try {
			phocus.createApp({
				container: phocusContainer,
				images: images,
				options: {
					loop: false,
					theme: 'light',
					maxZoom: 10,
					autoBind: true,
					platform: 'mobile',
					sliderVirtualSize: 3,
					sliderAddBefore: 1,
					sliderAddAfter: 1,
					hideDownloadButton: !ARTICLE_CONFIG.isCopyAllowed,
					hideOriginalImageButton: !ARTICLE_CONFIG.isCopyAllowed,
					onDownloadImage: downloadPhocusImage,
					enablePermalink: true,
				}
			});
		} catch {}

		function downloadImage(downloadUrl) {
			window.location.assign(downloadUrl);
		}

		function downloadPhocusImage(phocusImage) {
			var imageUrl = phocusImage.src;
			if (!imageUrl) {
				return;
			}

			if (/^(?:https?:|)\/\/t1(.beta|-beta|-sandbox|).(daumcdn|kakaocdn).net\/[a-zA-Z0-9.\/_]*$/.test(imageUrl)) {
				checkFileProperty(imageUrl + '?download', downloadImage);
			} else {
				downloadImage(imageUrl.replace('/image/', '/attach/'));
			}
		}
	}

	function refineArticleContents(){
		$('.figure-video iframe').each(function(){
			var calculatedMovieHeight = Math.round($(this.parentNode).width() * (360/640));
			$(this).css('height', calculatedMovieHeight);
		});
		if(ARTICLE_CONFIG.pf === "teahouse") {
			var html = article.html();
			html = html.replace(/&nbsp;/g, " ");
			article.html(html);
			article.find("table,img").removeAttr("style").removeAttr("width");
			article.find("img").addClass("txc-image");
			article.find("pre").css({"white-space": "pre-line", "word-spacing": "-0.1em"});
		}
	}

	function loadPlusMap(){
		if (typeof plusmap != "undefined") {
			plusmap.load(function () {
				plusmap.init($(".content_plusmap")).render({width: 300, showOuterLine: false});
			});
		}
	}


	function allowFullScreenOnMovieIframes(){
		// for android security update about iframe fullscreen 16/05/26
		$('iframe').each(function(){
			$(this).attr('allowfullscreen', 'true');
		});
	}

	function resizeTables(){
		const W = 712;
		article.find('table[data-ke-type=table]').each(function () {
			var trArray = $(this).find('tr');
			for(var i = 0; i < trArray.length; i++){
				if(trArray[i].childNodes.length > 3){
					this.style.minWidth = W + 'px';
					break;
				} else {
					if(article.width() < W) {
						this.style.width = '100%';
					}
				}
			}
		});
	}
	
	function setWebToAppEvents() {
		$("#btnSaveArticle, #btnWeb2App").on("click", function (event) {
			event.preventDefault();

			var isKakaoTalk = (ARTICLE_CONFIG.sns === "kakaotalk" || ARTICLE_CONFIG.svc === "kakaotalkTab");
			var schemeUrl = "daumcafe://";

			if (ARTICLE_CONFIG.istop === "true") {
				schemeUrl += topRankSchemeMake();
			} else if (isKakaoTalk) {
				schemeUrl += kakaoTalkSchemeMake();
			} else if (ARTICLE_CONFIG.sns) {
				schemeUrl += snsUrlSchemeMake();
			} else {
				schemeUrl += articleSchemeMake();
			}

			Utils.web2app(schemeUrl);
		});

		var topRankSchemeMake = function () {
			return "cafehome?grpcode=" + CAFEAPP.GRPCODE;
		};
		var kakaoTalkSchemeMake = function () {
			return "popular?grpcode=" + CAFEAPP.GRPCODE + "&fldid=" + CAFEAPP.FLDID +"&dataid=" + CAFEAPP.DATAID + "&sns=talk&categorytype=&categoryid=";
		};
		var snsUrlSchemeMake = function () {
			return "popular?grpcode=" + CAFEAPP.GRPCODE + "&fldid=" + CAFEAPP.FLDID +"&dataid=" + CAFEAPP.DATAID + "&sns=" + ARTICLE_CONFIG.sns + "&categorytype=&categoryid=";
		};
		var articleSchemeMake = function () {
			return "article?grpcode=" + CAFEAPP.GRPCODE + "&fldid=" + CAFEAPP.FLDID +"&dataid=" + CAFEAPP.DATAID;
		};
	}

	function initSocialShare(){
		if (ARTICLE_CONFIG.isSnsAllowed !== 'true'){
			return false;
		}

		var ogTitleContent = $("meta[property=\"og:title\"]").attr("content"),
			shareLink = "https://cafe.daum.net" + window.location.pathname + window.location.search,
			KAKAO_LINK_DATA = {
			shareType : 'sendCustom',
			shareData : {
				templateId: 7921,
				installTalk: true,
				templateArgs: {
					'${title}': $("meta[property=\"og:title\"]").attr("content"),
					'${description}': $("meta[property=\"og:description\"]").attr("content"),
					'${imageUrl}': $("meta[property=\"og:image\"]").attr("content"),
					'${webUrl}': $("meta[property=\"article:pc_url\"]").attr("content"),
					'${EncodingUrl}': encodeURIComponent($("meta[property=\"article:mobile_view_url\"]").attr("content")),
					'${mobileWebUrl}': $("meta[property=\"article:mobile_url\"]").attr("content")
				}
			}
		};

		useSocialShare({
			internalCss: '',
			externalCss: [
				'https://t1.daumcdn.net/daumtop_deco/socialshare/css/mo_common-v3.0.0-20240904.css',
				'https://t1.daumcdn.net/daumtop_deco/socialshare/css/mo_dark-3.0.0-20240826.css',
			],
			kakaoApi: {
				appkey: Utils.kakaoAPIKey,
				extraAppkey: Utils.kakaoAPIExtraKey,
			},
			socialList: [
				'kakaotalk',
				'facebook',
				'x',
				'mail',
				'cafe',
			],
		});
		var socialShareLayerContainer = document.getElementById('socialShareLayerContainer');
		socialShareLayerContainer.setSocialShare({
			buttonEl: document.querySelector('#socialShareContainer'),
			link: shareLink,
			prefix: ogTitleContent,
			service_name: 'Daum카페',
			kakaoLinkData: KAKAO_LINK_DATA
		});
	}

	return {
		init: init
	}
})();

window.isAdminAdoption = false;
window.adoptionCount = 0;
function deleteArticle(dataid) {
	if (window.confirm('해당 답변을 삭제하시겠습니까?')) {
		var form = document.getElementById('deleteArticleForm');
		form.action = '/' + CAFEAPP.GRPCODE + '/' + CAFEAPP.FLDID + '/' + dataid + '?method=DELETE';
		form.submit();
	}
}

function chooseAnswer(dataid, isAdmin) {
	if (window.isAdminAdoption && isAdmin) {
		window.alert('운영자는 1개까지만 채택 가능합니다.');
		return false;
	} else if (window.adoptionCount > 2) {
		window.alert('답변은 3개까지만 채택 가능합니다.');
		return false;

	} else {
		location.href = '/' + CAFEAPP.GRPCODE + '/' + CAFEAPP.FLDID + '/' + dataid + '/choose';
	}
}

function showMoreAnswers() {
	jQuery('#list_answer').children('li:hidden').each(function(index){
		if(index>19) return false;
		jQuery(this).removeAttr("style");
	});

	moveMoreTabToBottom();
}

function moveMoreTabToBottom() {
	if(jQuery('#list_answer').children('li:hidden').size() == 0){
		jQuery('.btn_more').remove();
		jQuery('.btn_up').show();
	}
}
function moveOnTop(){
	$(window).scrollTop(0);
}

// 투표를 보여줄 각 서비스에서 리사이즈 이벤트 받을 준비로 먼저 추가할 코드 
(function (){
	var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
	var eventer = window[eventMethod];
	var messageEvent = (eventMethod === "attachEvent") ? "onmessage" : "message";
	eventer(messageEvent, function(e) {
		var pollframe = jQuery('[data-ke-id=' + e.data.id + '] iframe');
		if(pollframe.length === 0) {
			pollframe = jQuery('#pollFrame')
		}
		pollframe.height(e.data.height);
	}, false);
})();
